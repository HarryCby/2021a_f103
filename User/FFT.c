#include "stm32f10x.h"                  // Device header
#include "math.h"
#include "arm_math.h"
#include "arm_const_structs.h"
#include "FFT.h"
//256点汉宁窗
extern u8 test_num;
// 这个参数从网上直接抄的简直是shiconst float hanning_win_table[256] = {0.000149421078453171, 0.000597595007177931, 0.00134425391964726, 0.00238895154954133,0.00373106349747415, 0.00536978760418699, 0.00730414442998667, 0.00953297784014107,0.0120549556958828, 0.0148685706506078, 0.0179721410507924, 0.0213638119410917,         0.0250415561730168, 0.0290031756165303, 0.0332463024738333, 0.0377684006945618,         0.0425667674915437, 0.0476385349562126, 0.0529806717727114, 0.0585899850296627,         0.0644631221285217, 0.0705965727873714, 0.0769866711389634, 0.0836295979217494,         0.0905213827625935, 0.0976579065498020, 0.105034903895052, 0.112647965682748,         0.120492541705279, 0.128563943382607, 0.136857346564560, 0.145367794414147, 0.154090200370186,         0.163019351187458, 0.172149910052584, 0.181476419773753, 0.190993306042403, 0.200694880764894,         0.210575345462196, 0.220628794735546, 0.230849219796014, 0.241230512055860, 0.251766466779543,         0.262450786792195, 0.273277086243339, 0.284238894423618, 0.295329659632231, 0.306542753092784,         0.317871472915207, 0.329309048101366, 0.340848642591985, 0.352483359352449, 0.364206244495054,         0.376010291435238, 0.387888445079305, 0.399833606041146, 0.411838634885427, 0.423896356394721,         0.435999563858022, 0.448141023378083, 0.460313478195001, 0.472509653023471, 0.484722258401111,         0.496943995045254, 0.509167558215622, 0.521385642080249, 0.533590944082063, 0.545776169303514,         0.557934034826625, 0.570057274085885, 0.582138641211355, 0.594170915359415, 0.606146905028547,         0.618059452357584, 0.629901437403849, 0.641665782398637, 0.653345455977481, 0.664933477382692,         0.676422920635650, 0.687806918676346, 0.699078667467724, 0.710231430062342, 0.721258540628942,         0.732153408436510, 0.742909521793458, 0.753520451939554, 0.763979856888295, 0.774281485217411,         0.784419179805244, 0.794386881510759, 0.804178632795004, 0.813788581281829, 0.823210983255770,         0.832440207094966, 0.841470736637101, 0.850297174476322, 0.858914245189185, 0.867316798487695,         0.875499812297549, 0.883458395759753, 0.891187792153812, 0.898683381740745, 0.905940684524234,         0.912955362928245, 0.919723224389528, 0.926240223863451, 0.932502466241655, 0.938506208680101,         0.944247862836110, 0.949723997013056, 0.954931338211443, 0.959866774085119, 0.964527354801480,         0.968910294804540, 0.973012974479810, 0.976832941720003, 0.980367913390621, 0.983615776694547,         0.986574590434830, 0.989242586174910, 0.991618169295584, 0.993699919948085, 0.995486593902703,         0.996977123292440, 0.998170617251262, 0.999066362446550, 0.999663823505453, 0.999962643334866,         0.999962643334866, 0.999663823505453, 0.999066362446550, 0.998170617251262, 0.996977123292440,         0.995486593902703, 0.993699919948085, 0.991618169295584, 0.989242586174910, 0.986574590434830,         0.983615776694547, 0.980367913390621, 0.976832941720003, 0.973012974479810, 0.968910294804540,         0.964527354801480, 0.959866774085119, 0.954931338211443, 0.949723997013056, 0.944247862836110,         0.938506208680101, 0.932502466241655, 0.926240223863451, 0.919723224389528, 0.912955362928245,         0.905940684524234, 0.898683381740745, 0.891187792153812, 0.883458395759753, 0.875499812297549,         0.867316798487695, 0.858914245189185, 0.850297174476322, 0.841470736637101, 0.832440207094966,         0.823210983255770, 0.813788581281829, 0.804178632795004, 0.794386881510759, 0.784419179805244,         0.774281485217411, 0.763979856888295, 0.753520451939554, 0.742909521793458, 0.732153408436510,         0.721258540628942, 0.710231430062342, 0.699078667467724, 0.687806918676346, 0.676422920635650,         0.664933477382692, 0.653345455977481, 0.641665782398637, 0.629901437403849, 0.618059452357584,         0.606146905028547, 0.594170915359415, 0.582138641211355, 0.570057274085885, 0.557934034826625,         0.545776169303514, 0.533590944082063, 0.521385642080249, 0.509167558215622, 0.496943995045254,         0.484722258401111, 0.472509653023471, 0.460313478195001, 0.448141023378083, 0.435999563858022,         0.423896356394721, 0.411838634885427, 0.399833606041146, 0.387888445079305, 0.376010291435238,         0.364206244495054, 0.352483359352449, 0.340848642591985, 0.329309048101366, 0.317871472915207,         0.306542753092784, 0.295329659632231, 0.284238894423618, 0.273277086243339, 0.262450786792195,         0.251766466779543, 0.241230512055860, 0.230849219796014, 0.220628794735546, 0.210575345462196,         0.200694880764894, 0.190993306042403, 0.181476419773753, 0.172149910052584, 0.163019351187458,         0.154090200370186, 0.145367794414147, 0.136857346564560, 0.128563943382607, 0.120492541705279,         0.112647965682748, 0.105034903895052, 0.0976579065498020, 0.0905213827625935,         0.0836295979217494, 0.0769866711389634, 0.0705965727873714, 0.0644631221285217,     0.0585899850296627, 0.0529806717727114, 0.0476385349562126, 0.0425667674915437,     0.0377684006945618, 0.0332463024738333, 0.0290031756165303, 0.0250415561730168,     0.0213638119410917, 0.0179721410507924, 0.0148685706506078, 0.0120549556958828,     0.00953297784014107, 0.00730414442998667, 0.00536978760418699, 0.00373106349747415,     0.00238895154954133, 0.00134425391964726, 0.000597595007177931, 0.000149421078453171    };
flag improve = True;
const float hanning_win_table[256] = {
    0.000000000000000, 0.000151774011064199, 0.000607003902855008, 0.00136541330710599,
    0.00242654179646779, 0.00378974516403213, 0.00545419581442702, 0.00741888326624673,
    0.00968261476551113, 0.0122440160097817, 0.0151015319824953, 0.0182534278970085,
    0.0216977902497796, 0.0254325279820494, 0.0294553737493142, 0.0337638852978221,
    0.0383554469472553, 0.0432272711786996, 0.0483764003269356, 0.0537997083760261,
    0.0594939028571078, 0.0654555268472358, 0.0716809610680687, 0.0781664260831168,
    0.0849079845922247, 0.0919015438218891, 0.0991428580099666, 0.106627530983258,
    0.114351018826410, 0.122308632640503, 0.130495541389670, 0.138906774833995,
    0.147537226546926, 0.156381657015369, 0.165434696820571, 0.174690849897879,
    0.184144496873374, 0.193789898475375, 0.203621199018723, 0.213632429959747,
    0.223817513519747, 0.234170266374782, 0.244684403409547, 0.255353541533038,
    0.266171203553707, 0.277130822111731, 0.288225743666038, 0.299449232533641,
    0.310794474978845, 0.322254583349841, 0.333822600260170, 0.345491502812526,
    0.357254206862329, 0.369103571318480, 0.381032402478691, 0.393033458396751,
    0.405099453279087, 0.417223061907935, 0.429396924088454, 0.441613649117072,
    0.453865820268349, 0.466145999297646, 0.478446730956852, 0.490760547520435,
    0.503079973319069, 0.515397529278085, 0.527705737457985, 0.539997125594271,
    0.552264231633827, 0.564499608265102, 0.576695827439343, 0.588845484880134,
    0.600941204578505, 0.612975643270874, 0.624941494897116, 0.636831495036041,
    0.648638425315601, 0.660355117795128, 0.671974459316964, 0.683489395824836,
    0.694892936646340, 0.706178158736952, 0.717338210882982, 0.728366317860920,
    0.739255784550643, 0.750000000000000, 0.760592441438293, 0.771026678236225,
    0.781296375809912, 0.791395299466581, 0.801317318189628, 0.811056408360737,
    0.820606657416789, 0.829962267439361, 0.839117558674617, 0.848066972981463,
    0.856805077205876, 0.865326566479347, 0.873626267439446, 0.881699141370552,
    0.889540287262835, 0.897144944787643, 0.904508497187474, 0.911626474078794,
    0.918494554165989, 0.925108567864807, 0.931464499833695, 0.937558491411496,
    0.943386842960031, 0.948946016110129, 0.954232635909762, 0.959243492872962,
    0.963975544928287, 0.968425919265655, 0.972591914080410, 0.976471000213578,
    0.980060822687314, 0.983359202134594, 0.986364136122302, 0.989073800366903,
    0.991486549841951, 0.993600919776785, 0.995415626545780, 0.996929568447637,
    0.998141826374215, 0.999051664368522, 0.999658530071512, 0.999962055057415,
    0.999962055057415, 0.999658530071512, 0.999051664368522, 0.998141826374215,
    0.996929568447637, 0.995415626545780, 0.993600919776785, 0.991486549841951,
    0.989073800366903, 0.986364136122302, 0.983359202134594, 0.980060822687314,
    0.976471000213578, 0.972591914080410, 0.968425919265655, 0.963975544928287,
    0.959243492872962, 0.954232635909762, 0.948946016110129, 0.943386842960031,
    0.937558491411496, 0.931464499833695, 0.925108567864807, 0.918494554165989,
    0.911626474078794, 0.904508497187474, 0.897144944787643, 0.889540287262835,
    0.881699141370552, 0.873626267439446, 0.865326566479347, 0.856805077205876,
    0.848066972981463, 0.839117558674617, 0.829962267439361, 0.820606657416789,
    0.811056408360737, 0.801317318189628, 0.791395299466581, 0.781296375809912,
    0.771026678236225, 0.760592441438293, 0.750000000000000, 0.739255784550643,
    0.728366317860920, 0.717338210882982, 0.706178158736952, 0.694892936646340,
    0.683489395824836, 0.671974459316964, 0.660355117795128, 0.648638425315601,
    0.636831495036041, 0.624941494897116, 0.612975643270874, 0.600941204578505,
    0.588845484880134, 0.576695827439343, 0.564499608265102, 0.552264231633827,
    0.539997125594271, 0.527705737457985, 0.515397529278085, 0.503079973319069,
    0.490760547520435, 0.478446730956852, 0.466145999297646, 0.453865820268349,
    0.441613649117072, 0.429396924088454, 0.417223061907935, 0.405099453279087,
    0.393033458396751, 0.381032402478691, 0.369103571318480, 0.357254206862329,
    0.345491502812526, 0.333822600260170, 0.322254583349841, 0.310794474978845,
    0.299449232533641, 0.288225743666038, 0.277130822111731, 0.266171203553707,
    0.255353541533038, 0.244684403409547, 0.234170266374782, 0.223817513519747,
    0.213632429959747, 0.203621199018723, 0.193789898475375, 0.184144496873374,
    0.174690849897879, 0.165434696820571, 0.156381657015369, 0.147537226546926,
    0.138906774833995, 0.130495541389670, 0.122308632640503, 0.114351018826410,
    0.106627530983258, 0.0991428580099666, 0.0919015438218891, 0.0849079845922247,
    0.0781664260831168, 0.0716809610680687, 0.0654555268472358, 0.0594939028571078,
    0.0537997083760261, 0.0483764003269356, 0.0432272711786996, 0.0383554469472553,
    0.0337638852978221, 0.0294553737493142, 0.0254325279820494, 0.0216977902497796,
    0.0182534278970085, 0.0151015319824953, 0.0122440160097817, 0.00968261476551113,
    0.00741888326624673, 0.00545419581442702, 0.00378974516403213, 0.00242654179646779,
    0.00136541330710599, 0.000607003902855008, 0.000151774011064199, 0.000000000000000
};
const float blackman_win_table[256] = {
        0,
        5.46533866073867e-05,
        0.000218757215420154,
        0.000492741976797648,
        0.000877323433985985,
        0.00137350004683288,
        0.00198254937446228,
        0.00270602346635644,
        0.00354574325395027,
        0.00450379195747200,
        0.00558250752535799,
        0.00678447412611746,
        0.00811251271502363,
        0.00956967070045470,
        0.0111592107370887,
        0.0128845986754748,
        0.0147494906997470,
        0.0167577196874082,
        0.0189132808271956,
        0.0212203165330305,
        0.0236831006939482,
        0.0263060223017084,
        0.0290935684994756,
        0.0320503070965507,
        0.0351808685956095,
        0.0384899277802619,
        0.0419821849119940,
        0.0456623465866679,
        0.0495351063017557,
        0.0536051247863504,
        0.0578770101467346,
        0.0623552978808990,
        0.0670444308158753,
        0.0719487390220911,
        0.0770724197591586,
        0.0824195175075841,
        0.0879939041408137,
        0.0937992592918366,
        0.0998390509682263,
        0.106116516469033,
        0.112634643656333,
        0.119396152633505,
        0.126403477881444,
        0.133658750902911,
        0.141163783424121,
        0.148920051201390,
        0.156928678479352,
        0.165190423145702,
        0.173705662625905,
        0.182474380559530,
        0.191496154298117,
        0.200770143262530,
        0.210295078195771,
        0.220069251345089,
        0.230090507605086,
        0.240356236651189,
        0.250863366090561,
        0.261608355655069,
        0.272587192458484,
        0.283795387337503,
        0.295227972293637,
        0.306879499050321,
        0.318744038736978,
        0.330815182708993,
        0.343086044509883,
        0.355549262979122,
        0.368197006506363,
        0.381020978429985,
        0.394012423575122,
        0.407162135923567,
        0.420460467405170,
        0.433897337797630,
        0.447462245718831,
        0.461144280693253,
        0.474932136271276,
        0.488814124177672,
        0.502778189462994,
        0.516811926629105,
        0.530902596697676,
        0.545037145188141,
        0.559202220969306,
        0.573384195946654,
        0.587569185545265,
        0.601743069946267,
        0.615891516032847,
        0.630000000000000,
        0.644053830580545,
        0.658038172838312,
        0.671938072477938,
        0.685738480619360,
        0.699424278983862,
        0.712980305437397,
        0.726391379835968,
        0.739642330116945,
        0.752718018579534,
        0.765603368296970,
        0.778283389602607,
        0.790743206591723,
        0.802968083580714,
        0.814943451465282,
        0.826654933919355,
        0.838088373376686,
        0.849229856737469,
        0.860065740742819,
        0.870582676960606,
        0.880767636326930,
        0.890607933188409,
        0.900091248791531,
        0.909205654166471,
        0.917939632354069,
        0.926282099926101,
        0.934222427750503,
        0.941750460954848,
        0.948856538043175,
        0.955531509123088,
        0.961766753202076,
        0.967554194514015,
        0.972886317839036,
        0.977756182782138,
        0.982157436978311,
        0.986084328194299,
        0.989531715299657,
        0.992495078082259,
        0.994970525886072,
        0.996954805051615,
        0.998445305142277,
        0.999440063942375,
        0.999937771215645,
        0.999937771215645,
        0.999440063942375,
        0.998445305142277,
        0.996954805051615,
        0.994970525886072,
        0.992495078082259,
        0.989531715299657,
        0.986084328194299,
        0.982157436978311,
        0.977756182782138,
        0.972886317839036,
        0.967554194514015,
        0.961766753202076,
        0.955531509123088,
        0.948856538043175,
        0.941750460954848,
        0.934222427750503,
        0.926282099926101,
        0.917939632354069,
        0.909205654166471,
        0.900091248791531,
        0.890607933188409,
        0.880767636326930,
        0.870582676960606,
        0.860065740742819,
        0.849229856737469,
        0.838088373376686,
        0.826654933919355,
        0.814943451465282,
        0.802968083580714,
        0.790743206591723,
        0.778283389602607,
        0.765603368296970,
        0.752718018579534,
        0.739642330116945,
        0.726391379835968,
        0.712980305437397,
        0.699424278983862,
        0.685738480619360,
        0.671938072477938,
        0.658038172838312,
        0.644053830580545,
        0.630000000000000,
        0.615891516032847,
        0.601743069946267,
        0.587569185545265,
        0.573384195946654,
        0.559202220969306,
        0.545037145188141,
        0.530902596697676,
        0.516811926629105,
        0.502778189462994,
        0.488814124177672,
        0.474932136271276,
        0.461144280693253,
        0.447462245718831,
        0.433897337797630,
        0.420460467405170,
        0.407162135923567,
        0.394012423575122,
        0.381020978429985,
        0.368197006506363,
        0.355549262979122,
        0.343086044509883,
        0.330815182708993,
        0.318744038736978,
        0.306879499050321,
        0.295227972293637,
        0.283795387337503,
        0.272587192458484,
        0.261608355655069,
        0.250863366090561,
        0.240356236651189,
        0.230090507605086,
        0.220069251345089,
        0.210295078195771,
        0.200770143262530,
        0.191496154298117,
        0.182474380559530,
        0.173705662625905,
        0.165190423145702,
        0.156928678479352,
        0.148920051201390,
        0.141163783424121,
        0.133658750902911,
        0.126403477881444,
        0.119396152633505,
        0.112634643656333,
        0.106116516469033,
        0.0998390509682263,
        0.0937992592918366,
        0.0879939041408137,
        0.0824195175075841,
        0.0770724197591586,
        0.0719487390220911,
        0.0670444308158753,
        0.0623552978808990,
        0.0578770101467346,
        0.0536051247863504,
        0.0495351063017557,
        0.0456623465866679,
        0.0419821849119940,
        0.0384899277802619,
        0.0351808685956095,
        0.0320503070965507,
        0.0290935684994756,
        0.0263060223017084,
        0.0236831006939482,
        0.0212203165330305,
        0.0189132808271956,
        0.0167577196874082,
        0.0147494906997470,
        0.0128845986754748,
        0.0111592107370887,
        0.00956967070045470,
        0.00811251271502363,
        0.00678447412611746,
        0.00558250752535799,
        0.00450379195747200,
        0.00354574325395027,
        0.00270602346635644,
        0.00198254937446228,
        0.00137350004683288,
        0.000877323433985985,
        0.000492741976797648,
        0.000218757215420154,
        5.46533866073867e-05,
        0
    };

float32_t FFT_In[FFT_Len*2];
float32_t	FFT_IN_Non[FFT_Len*2];
float32_t FFT_Mag[FFT_Len];
void FFT_TEST(void)
{
	uint16_t i;
// 去除直流分量后放入 FFT_In 的高位
// 可以考虑等比例扩大FFT_In[2*i]
	//ADC_SourceData是int16_t
	
	
	/*****************去平均(准确的说不是去直流)*/
	float32_t mean;
	u32 temp;
	temp = 0;
	for (i = 0; i < FFT_Len; i++) {
			temp += ADC_SourceData[i];
	}
	mean = (float32_t)temp / FFT_Len;
	if(start_sign_0){
		if(test_num==0){
				for(i=0;i<FFT_Len;i++)
				{
					FFT_In[2*i]=((float)ADC_SourceData[i]-mean)*hanning_win_table[i];    //((ADC_SourceData[i])-2048)去直流(0.5*arm_sin_f32(2*Pi*1000/Fs*i)+0.25*arm_sin_f32(2*Pi*2000/Fs*i)+0.1*arm_sin_f32(2*Pi*3000/Fs*i));
					//程序生成数据不加窗状态下结果极佳，加窗后比例不对
					FFT_In[2*i+1]=0;
				}
		}
		else{
				for(i=0;i<FFT_Len;i++)
				{
					FFT_In[2*i]=((float)ADC_SourceData[i]-mean)*blackman_win_table[i];    //((ADC_SourceData[i])-2048)去直流(0.5*arm_sin_f32(2*Pi*1000/Fs*i)+0.25*arm_sin_f32(2*Pi*2000/Fs*i)+0.1*arm_sin_f32(2*Pi*3000/Fs*i));
					//程序生成数据不加窗状态下结果极佳，加窗后比例不对
					FFT_In[2*i+1]=0;
				}
		}
	}
	else if(start_sign_1){
		if(test_num<=3){
//			float temp;
				for(i=0;i<FFT_Len;i++)
				{
					FFT_In[2*i]=((float)ADC_SourceData[i]-mean)*hanning_win_table[i];   //*hanning_win_table[i]//((ADC_SourceData[i])-2048)去直流(0.5*arm_sin_f32(2*Pi*1000/Fs*i)+0.25*arm_sin_f32(2*Pi*2000/Fs*i)+0.1*arm_sin_f32(2*Pi*3000/Fs*i));
					FFT_In[2*i+1]=0;
				}
		}
		else{
				for(i=0;i<FFT_Len;i++)
				{
					FFT_In[2*i]=((float)ADC_SourceData[i]-mean)*hanning_win_table[i];  //((ADC_SourceData[i])-2048)去直流(0.5*arm_sin_f32(2*Pi*1000/Fs*i)+0.25*arm_sin_f32(2*Pi*2000/Fs*i)+0.1*arm_sin_f32(2*Pi*3000/Fs*i));   blackman_win_table
					FFT_In[2*i+1]=0;
				}
				}
		}
		arm_cfft_f32(&arm_cfft_sR_f32_len256,FFT_In ,0,1);//注意的是输入和输出共用一块缓存
		arm_cmplx_mag_f32(FFT_In, FFT_Mag, FFT_Len);
		//Get mag
		FFT_Mag[0]=FFT_Mag[0]/2;
		//获取相位在main函数中完成
}
